<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Bart Debunne">
<title>IIIF : Deliverable 4 - APPENDIX B: image processing workflow</title>
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */

@import url(//fonts.googleapis.com/css?family=Noto+Sans);
@import url(https://cdn.jsdelivr.net/gh/asciidoctor/asciidoctor@2.0/data/stylesheets/asciidoctor-default.css); /* Default asciidoc style framework - important */

/* CUSTOMISATIONS */
/* Change the values in root for quick customisation. If you want even more fine grain... venture further. */
:root{
--maincolor:#FFFFFF;
--primarycolor:#000000;
--secondarycolor:#AAAAAA;
--tertiarycolor:#CCCCCC;
--sidebarbackground:#CACACA;
--linkcolor:#0D47A1;
--linkcoloralternate:#B71C1C;
--white:#FFFFFF;
--black:#000000;
}

/* Text styles */

body{font-family: "Noto Sans",sans-serif;background-color: var(--maincolor);color:var(--black);}

h1{color:var(--primarycolor) !important;font-family:"Noto Sans",sans-serif;}
h2,h3,h4,h5,h6{color:var(--secondarycolor) !important;font-family:"Noto Sans",sans-serif;}
.title{color:var(--black) !important;font-family:"Noto Sans",sans-serif;font-style: normal; font-weight: normal;}
a{text-decoration: none;}
p{font-family: "Noto Sans",sans-serif ! important}
#toc.toc2 a:link{color:var(--linkcolor);}
blockquote{color:var(--secondarycolor) !important}
.quoteblock{color:var(--black)}
.quoteblock blockquote:before{color:var(--black)}
code{color:var(--white);background-color: var(--secondarycolor) !important}
mark{background-color: var(--tertiarycolor)} /* Text highlighting color */

/* Table styles */
th{background-color: var(--maincolor);color:var(--black) !important;}
td{background-color: var(--maincolor);color: var(--black) !important}


#toc.toc2{background-color:var(--sidebarbackground);}
#toctitle{color:var(--white);}

/* Responsiveness fixes */
video {
  max-width: 100%;
}

@media all and (max-width: 600px) {
table {
  width: 55vw!important;
  font-size: 3vw;
}

</style>
</head>
<body class="article data-line-1">
<div id="header">
<h1>IIIF : Deliverable 4 - APPENDIX B: image processing workflow</h1>
<div class="details">
<span id="author" class="author">Bart Debunne</span><br>
<span id="email" class="email"><a href="mailto:bart.debunne@meemoo.be">bart.debunne@meemoo.be</a></span><br>
<span id="revnumber">version 1,</span>
<span id="revdate">17-05-2021</span>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div id="toc" class="data-line-24">
<div id="toctitle" class="title">Inhoudsopgave</div>
<ul class="sectlevel1">
<li><a href="#_doelstelling">Doelstelling</a></li>
<li><a href="#_specificaties">Specificaties</a>
<ul class="sectlevel2">
<li><a href="#_afgeleide_beeldbestanden">Afgeleide beeldbestanden</a></li>
<li><a href="#_relatief_herschalen">Relatief herschalen</a></li>
</ul>
</li>
<li><a href="#_taken">Taken</a>
<ul class="sectlevel2">
<li><a href="#_extract">Extract</a>
<ul class="sectlevel3">
<li><a href="#_transform">Transform</a></li>
<li><a href="#_load">Load</a></li>
<li><a href="#_clean">Clean</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_workflow">Workflow</a></li>
<li><a href="#_omgeving">Omgeving</a></li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1 data-line-28">
<h2 id="_doelstelling">Doelstelling</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1 data-line-30">
<h2 id="_specificaties">Specificaties</h2>
<div class="sectionbody">
<div class="sect2 data-line-32">
<h3 id="_afgeleide_beeldbestanden">Afgeleide beeldbestanden</h3>
<div class="admonitionblock caution data-line-34">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
Voor afgeleide bestanden moet onderscheid worden gemaakt tussen werken in public domain en werken die nog onder het auteursrecht vallen. In de overeenkomst die de VKC momenteel met de auteursrechtenorganisatie Sabam heeft, worden volgende hergebruiksvoorwaarden vooropgesteld voor werken die onder het auteursrecht vallen: de resolutie van het gereproduceerde beeld mag niet meer dan 640x480 pixels zijn en een resolutie van maximum 72dpi hebben. Onderstaande specificaties hebben betrekking op werken die niet onder die overeenkomst vallen.
</td>
</tr>
</table>
</div>
<div class="exampleblock data-line-36">
<div class="content">
<div class="ulist data-line-37">
<ul>
<li class="data-line-37">
<p>jpeg-2000 (jp2)</p>
</li>
<li class="data-line-38">
<p>300 ppi</p>
</li>
<li class="data-line-39">
<p>sRGB</p>
</li>
<li class="data-line-40">
<p>Bestanden worden bijgesneden (<em>crop</em>), randinformatie zoals kleurkaarten en kaders verwijderd</p>
</li>
<li class="data-line-41">
<p>Embedded metadata(XMP, Exif, ICC) wordt indien aanwezig overgenomen van het origineel</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2 data-line-44">
<h3 id="_relatief_herschalen"><a id="rel-scale"></a>Relatief herschalen</h3>
<div class="paragraph data-line-46">
<p>De te ontsluiten collectie is zowel qua type als qua fysieke afmeting zeer divers, voor de hele VKC-collectie spreken we over heel kleine objecten van een paar centimeter tot wandtapijten, of een wandkaart van ettelijke meters hoog en breed. De afmeting in pixels van het digitale beeld is niet per se in verhouding en is afhankelijk van het moment van de opname, de fotograaf, het opnametoestel, etc. Voor sommige grote werken zijn verschillende foto&#8217;s aan elkaar geplakt (stitching). Andere zijn gevat in 1 foto. Relatief gesproken kan een groter fysiek werk in aantal pixels kleiner of gelijk zijn aan een fysiek kleiner werk.</p>
</div>
<div class="paragraph data-line-48">
<p>Om te vermijden dat (heel) grote werken te fel herschaald worden ten opzichte van kleine werken met een in verhouding hoger aantal pixels, zal binnen dit project bekeken worden in welke mate een relatie bestaat tussen de fysieke en digitale afmetingen op basis waarvan herschaling dynamisch kan gebeuren. We onderzoeken dit aan de hand van een aantal typewerken zoals bijvoorbeeld <em>Pierrot et Squelette en Jaune</em> van James Ensor.</p>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-50">
<h2 id="_taken">Taken</h2>
<div class="sectionbody">
<div class="paragraph data-line-52">
<p>De workflow kan gezien worden als een ETL-proces. Hierin worden min of meer procedureel de volgende taken uitgevoerd:</p>
</div>
<div class="ulist data-line-54">
<ul>
<li class="data-line-54">
<p>Haal bestand op van tape aan de hand van een id</p>
</li>
<li class="data-line-55">
<p>Detecteer randinformatie en snij bij indien nodig</p>
</li>
<li class="data-line-56">
<p>Herschaal tot bepaalde grootte</p>
</li>
<li class="data-line-57">
<p>Zet om naar sRGB</p>
</li>
<li class="data-line-58">
<p>Sla op als gecomprimeerde jp2 inclusief originele metadata</p>
</li>
<li class="data-line-59">
<p>Analyseer en valideer resultaat</p>
</li>
<li class="data-line-60">
<p>Verplaatst naar eindbestemming</p>
</li>
<li class="data-line-61">
<p>Kuis op</p>
</li>
</ul>
</div>
<div class="sect2 data-line-63">
<h3 id="_extract">Extract</h3>
<div class="paragraph data-line-65">
<p>Exporteer de originele tiff-bestanden van tape naar lokale disk. Op basis van een of meerdere pids (external_id) met behulp van de MediaHaven REST API. (There&#8217;s a python lib for that)</p>
</div>
<div class="paragraph data-line-67">
<p>In deze fase doen we eenmalig een export van beelden die nu reeds ontsloten worden via de VKC Arthub, vb. <a href="https://arthub.vlaamsekunstcollectie.be/nl/catalog/mskgent:1907-A" class="bare">https://arthub.vlaamsekunstcollectie.be/nl/catalog/mskgent:1907-A</a>, naar disk. Van daaruit kunnen dan een of meer bestanden naar een werkfolder gekopieerd worden om de workflow te bouwen en te testen, zonder dat de originele bestanden telkens opnieuw geëxporteerd moeten worden.</p>
</div>
<div class="paragraph data-line-69">
<p>Te onderzoeken hoe in een productieomgeving dit getriggered kan worden. Bijvoorbeeld door plaatsen van een metadata flag in MAM waardoor export naar een watch_folder on disk en de rest van de workflow automatisch getriggerd kan worden.</p>
</div>
<div class="sect3 data-line-71">
<h4 id="_transform">Transform</h4>
<div class="sect4 data-line-73">
<h5 id="_detect_en_crop_kleurenkaart">Detect en crop kleurenkaart</h5>
<div class="paragraph data-line-75">
<p>Voor het detecteren van de kleurenkaart maken we gebruik van de <a href="https://github.com/tckrishna/colorchecker">colorchecker</a> zoals ontwikkeled voor het Flore de Gand project. Wanneer een kleurenkaart wordt herkend dan wordt de afbeelding bijgesneden en opgeslaan.</p>
</div>
<div class="paragraph data-line-77">
<p>Zie: <a href="https://github.com/tckrishna/colorchecker.git" class="bare">https://github.com/tckrishna/colorchecker.git</a></p>
</div>
<div class="quoteblock data-line-80">
<blockquote>
The code is such that, when an input image is provided, it would perform detections and crop out the colour scale so that only the painting would be saved.
</blockquote>
</div>
<div class="paragraph data-line-82">
<p>Documentatie en tutorial op: <a href="https://colab.research.google.com/drive/1OreAxCrCTkTqbIxu2Z_8KWuCujKyyncI?usp=sharing" class="bare">https://colab.research.google.com/drive/1OreAxCrCTkTqbIxu2Z_8KWuCujKyyncI?usp=sharing</a></p>
</div>
</div>
<div class="sect4 data-line-84">
<h5 id="_resize">Resize</h5>
<div class="paragraph data-line-86">
<p><code>TODO</code> Analyse nodig van de ratio fysieke afmeting tgo afmeting in pixels. Aan de hand van een representatief staal wordt gekeken of er een relevante relatie is tussen de grootte van een afbeelding en de fysieke afmeting van een werk en of het al dan niet nuttig is rekening mee te houden bij het herschalen van het digitale beeld. Zie boven bij <a href="#rel-scale">Relatief herschalen</a></p>
</div>
<div class="paragraph data-line-88">
<p>De afbeelding wordt herschaald binnen een voorafbepaalde marge. Momenteel is de baseline vastgesteld op 5000px voor de langste zijde.</p>
</div>
<div class="paragraph data-line-90">
<p>Zowel de huidige afmetingen bepalen als <em>resize</em> kan met standaard python modules zoals
<a href="https://pillow.readthedocs.io/en/stable/reference/Image.html">pillow</a>. Bijvoorbeeld:</p>
</div>
<div class="listingblock data-line-93">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">from PIL import Image

# Image size in pixels
image = Image.open('some.tif')
width, height = image.size</code></pre>
</div>
</div>
</div>
<div class="sect4 data-line-101">
<h5 id="_detect_and_set_color_profile">Detect and set Color Profile</h5>
<div class="paragraph data-line-103">
<p>Bij het encoderen van een bestand met <code>kdu_compress</code> wordt het kleurenprofiel vervangen door de value voor <code>-jp2_space</code> (zie <a href="#kdu-icc">kdu_compress</a>) Het is echter onduidelijk of dit ook daadwerkelijk het bestand omzet naar dit profiel. En of dit ook geldt wanneer een afbeelding geen kleurenprofiel heeft.</p>
</div>
<div class="paragraph data-line-105">
<p>Zoniet moet eerst gedetecteerd worden of er een profile aanwezig is en zoniet moet dit worden gezet als <code>sRGB</code>.</p>
</div>
<div class="paragraph data-line-107">
<p>Voorbeeld in Python met pillow of skimage:
<a href="https://scikit-image.org/docs/dev/api/skimage.color.html#convert-colorspace" class="bare">https://scikit-image.org/docs/dev/api/skimage.color.html#convert-colorspace</a></p>
</div>
</div>
<div class="sect4 data-line-110">
<h5 id="_encode">Encode</h5>
<div class="paragraph data-line-112">
<p>Voor het comprimeren en opslaan als jp2 gebruiken we de Kakadu software (binaries) waarvoor we een license hebben.</p>
</div>
<div class="listingblock data-line-115">
<div class="content">
<pre class="highlight"><code>kdu_compress -i input.tif -o output.jp2 Clevels=6 Clayers=6 "Cprecincts={256,256},{256,256},{128,128}" "Stiles={512,512}" Corder=RPCL ORGgen_plt=yes ORGtparts=R "Cblk={64,64}" -jp2_space "sRGB" Cuse_sop=yes Cuse_eph=yes -flush_period 1024 Creversible=no -rate 3</code></pre>
</div>
</div>
<div class="admonitionblock important data-line-117">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The JPEG 2000 format supports only a restricted set of ICC Profile features.
The <a id="kdu-icc"></a>-jp2_space parameter on kdu_compress sets the colour profile in the image metadata, but does not otherwise convert the image - the pixel values remain the same. The sRGB value sets the colour profile to the sRGB IEC61966-2.1 profile. (This is not the only way to set the colour profile)
Kakadu (and JP2 itself) will not support CYMK images:
Only three colour channels, R (red), G (green) and B (blue), are supported by the JP2 file format.
For example the sRGB v4 ICC preference profile is not supported, and cannot be embedded into a JP2 file using Kakadu. Setting -jp2_space sRGB on kdu_compress will erase the embedded profile and so allow it to be converted. The sRGB IEC61966-2.1 profile thus assigned is sufficiently different that in some cases there is a noticeable tint to the created JP2.
<em><a href="https://readthedocs.org/projects/image-processing/downloads/pdf/latest/" class="bare">https://readthedocs.org/projects/image-processing/downloads/pdf/latest/</a></em>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4 data-line-125">
<h5 id="_copy_metadata">Copy metadata</h5>
<div class="paragraph data-line-127">
<p>kdu_compress kopieert niet alle metadata tags.</p>
</div>
<div class="paragraph data-line-129">
<p>Suggestie: copy (all) tags from src to dest, met exiftool
<a href="https://manpages.ubuntu.com/manpages/artful/man1/exiftool.1p.html#copying%20examples" class="bare">https://manpages.ubuntu.com/manpages/artful/man1/exiftool.1p.html#copying%20examples</a></p>
</div>
</div>
<div class="sect4 data-line-132">
<h5 id="_test_en_validate">Test en validate</h5>
<div class="paragraph data-line-134">
<p>Valideer dat het eindresultaat voldoet aan de volgende assertions</p>
</div>
<div class="ulist data-line-136">
<ul>
<li class="data-line-136">
<p>ppi = 300</p>
</li>
<li class="data-line-137">
<p>icc = sRGB</p>
</li>
<li class="data-line-138">
<p>metadata tags = source file tags</p>
</li>
<li class="data-line-139">
<p>file is valid jp2</p>
</li>
</ul>
</div>
<div class="paragraph data-line-141">
<p><a href="https://jpylyzer.openpreservation.org" class="bare">https://jpylyzer.openpreservation.org</a>
<a href="https://github.com/openpreserve/jpylyzer" class="bare">https://github.com/openpreserve/jpylyzer</a>
<a href="https://exiftool.org/index.html" class="bare">https://exiftool.org/index.html</a>
<a href="https://exiftool.org/exiftool_pod.html" class="bare">https://exiftool.org/exiftool_pod.html</a></p>
</div>
</div>
</div>
<div class="sect3 data-line-146">
<h4 id="_load">Load</h4>
<div class="paragraph data-line-148">
<p>Bestanden worden naar de eindbestemming gekopieerd waar ze steekproefsgewijs visueel geïnspecteerd kunnen worden.</p>
</div>
<div class="paragraph data-line-150">
<p>De eidnbestemming is een folder die de media mount point is voor de IIPImage server.</p>
</div>
</div>
<div class="sect3 data-line-152">
<h4 id="_clean">Clean</h4>
<div class="paragraph data-line-154">
<p>Tussentijdse bestanden en met succes verwerkte bronbestanden worden verwijderd.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-156">
<h2 id="_workflow">Workflow</h2>
<div class="sectionbody">
<div class="imageblock data-line-159">
<div class="content">
<a class="image" href="https://cawemo.com/share/d893035f-bdbc-419b-9524-e9ff161992d7"><img src="images/iiif-jp2-derived-image-workflow.svg" alt="workflow voor creatie afgeleiden als jp2"></a>
</div>
<div class="title">Figure 1. Voorbeeld manuele workflow voor creatie van jp2 afgeleide beeldbestanden</div>
</div>
<div class="paragraph data-line-161">
<p>Voor de creatie van de afgeleiden starten we met een vrij manuele workflow die eenvoudig kan bijgesteld worden om uiteindelijk te komen tot een  automatiseerbare workflow.
Om zowel de workflow voor de creatie van afgeleide beelden als de specificaties an sich te testen beperken we ons in eerste instantie tot de omzetting van de beelden die nu reeds beschikbaar zijn in de IIIF-viewer in de VKC Arthub. Hierbij zal worden onderzocht welke een haalbare workflow is voor de aanmaak van de afgeleide beeldbestanden en in welke mate dit proces geautomatiseerd kan worden. Indien nodig kunnen bovenstaande specificaties dan ook bijgewerkt worden op basis van voortschrijdend inzicht.</p>
</div>
</div>
</div>
<div class="sect1 data-line-164">
<h2 id="_omgeving">Omgeving</h2>
<div class="sectionbody">
<div class="paragraph data-line-166">
<p>DEV: lokaal
QAS en PRD: Debian VM + data store (disk)</p>
</div>
<div class="paragraph data-line-169">
<p>Minstens nodig:
* Taal: Python
* Metadata read/write: exiftool
* jp2 schrijven: kdu_compress (kakadu)
* jp2 validatie: jpylyzer
* Tests: ?
* Orchestration: Airflow?</p>
</div>
</div>
</div>
</div>
</body>
</html>